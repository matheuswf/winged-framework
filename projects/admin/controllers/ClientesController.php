<?phpuse Winged\Controller\Controller;use Winged\Model\Login;use Winged\Winged;use Winged\Model\Clientes;use Winged\Http\Session;use Winged\Model\EnderecosClientes;use Winged\Http\Cookie;use Winged\Database\DbDict;class ClientesController extends Controller{    public function __construct()    {        !Login::permission() ? $this->redirectTo() : null;        parent::__construct();        $this->dynamic('active_page_group', 'clientes');        $this->dynamic('page_name', 'Clientes');        $this->dynamic('page_action_string', 'Listando');        $this->dynamic('list', 'clientes/');        $this->dynamic('insert', 'clientes/insert/');        $this->dynamic('update', 'clientes/update/');    }    public function actionIndex()    {        $this->redirectTo(Winged::$page_surname . '/page/1');    }    public function actionPage()    {        AdminAssets::init($this);        $this->setNicknamesToUri(['page']);        $limit = get('limit') ? get('limit') : 10;        $page = uri('page') ? uri('page') : 1;        $model = new Clientes();        $success = null;        if (!in_array(Session::get('action'), ['insert', 'update']) && Session::get('action') !== false) {            $success = $model->findOne(Session::get('action'));        }        $success = false;        if (intval(Session::get('action')) > 0) {            $success = true;        }        Session::remove('action');        $links = 1;        $model->select()->from(['CLIENTES' => 'clientes']);        \Admin::buildSearchModel($model, [            'CLIENTES.nome',            'CLIENTES.nome_fantasia',            'CLIENTES.razao_social',            'CLIENTES.inscricao_estadual',            'CLIENTES.data_cadastro',            'CLIENTES.email',            'CLIENTES.cnpj',            'CLIENTES.cpf',            'CLIENTES.rg',            'CLIENTES.status',        ]);        \Admin::buildOrderModel($model, [            'sort_nome' => 'CLIENTES.nome',            'sort_nome_fantasia' => 'CLIENTES.nome_fantasia',            'sort_razao_social' => 'CLIENTES.razao_social',            'sort_inscricao_estadual' => 'CLIENTES.inscricao_estadual',            'sort_data_cadastro' => 'CLIENTES.data_cadastro',            'sort_email' => 'CLIENTES.email',            'sort_cnpj' => 'CLIENTES.cnpj',            'sort_cpf' => 'CLIENTES.cpf',            'sort_rg' => 'CLIENTES.rg',            'sort_status' => 'CLIENTES.status',        ]);        $paginate = new Paginate($model->count(), $model);        $data = $paginate->getData($limit, $page);        $links = $paginate->createLinks($links, Winged::$page_surname);        $this->html(Winged::$page_surname . '/' . Winged::$page_surname . '/_index', [            'success' => $success,            'models' => $data->data,            'links' => $links,        ]);    }    public function actionInsert()    {        $this->dynamic('page_action_string', 'Inserindo');        AdminAssets::init($this);        $this->appendJs('enderecos_clientes', './admin/assets/js/pages/enderecos_clientes.js');        $model = new Clientes();        $endereco = new EnderecosClientes();        Session::always('action', 'insert');        if (is_get()) {            $this->html(Winged::$page_surname . '/' . Winged::$page_surname . '/_form', [                'model' => $model,                'endereco' => $endereco            ]);        } else if (is_post()) {            $save = $this->save();            if (!$save['status']) {                $this->html(Winged::$page_surname . '/' . Winged::$page_surname . '/_form', [                    'model' => $save['model'],                    'endereco' => $save['endereco'],                ]);            }        }    }    public function actionDelete()    {        $model = new Clientes();        $this->setNicknamesToUri(['id']);        if (uri('id') !== false && is_get()) {            $model->autoLoadDb(uri('id'));            $model->remove();        }        if (($to = Cookie::get('from_url'))) {            Cookie::remove('from_url');            $this->redirectOnly($to);        } else {            $this->redirectTo(Winged::$page_surname);        }    }    public function actionUpdate()    {        $this->dynamic('page_action_string', 'Alterando');        AdminAssets::init($this);        $this->appendJs('enderecos_clientes', './admin/assets/js/pages/enderecos_clientes.js');        $model = new Clientes();        $endereco = new EnderecosClientes();        $this->setNicknamesToUri(['id']);        if (uri('id') !== false && is_get()) {            $model->autoLoadDb(uri('id'));            if ($model->primaryKey()) {                $endereco = $endereco->select()                    ->from(['ENDERECOS' => EnderecosClientes::tableName()])                    ->where(ELOQUENT_EQUAL, ['ENDERECOS.id_cliente' => $model->id_cliente])                    ->andWhere(ELOQUENT_EQUAL, ['ENDERECOS.principal' => 1])                    ->one();                if(!$endereco){                    $endereco = new EnderecosClientes();                    $endereco->id_cliente = $model->id_cliente;                }                Session::always('action', 'update');                $this->html(Winged::$page_surname . '/' . Winged::$page_surname . '/_form', [                    'model' => $model,                    'endereco' => $endereco,                ]);            } else {                if (($to = Cookie::get('from_url'))) {                    Cookie::remove('from_url');                    $this->redirectOnly($to);                } else {                    $this->redirectTo(Winged::$page_surname);                }            }        } else if (is_post()) {            $save = $this->save();            if (!$save['status']) {                $this->html(Winged::$page_surname . '/' . Winged::$page_surname . '/_form', [                    'model' => $save['model'],                    'endereco' => $save['endereco'],                ]);            }        }    }    public function save()    {        $model = (new Clientes())->load($_POST);        $endereco = (new EnderecosClientes())->load($_POST);        $cliente_ok = $model->validate();        $endereco_ok = $endereco->validate();        if ($cliente_ok && $endereco_ok) {            $id = $model->save();            if($id){                $arr = [                    'EnderecosClientes' => [                        'id_cliente' => $id,                    ]                ];                $endereco->load($arr);                $endereco->principal = 1;                $endereco->save();                (new EnderecosClientes())->update(['ENDERECOS' => 'enderecos_clientes'])->set([                    'principal' => 0,                ])->where(ELOQUENT_EQUAL, ['ENDERECOS.id_cliente' => $endereco->id_cliente])                    ->andWhere(ELOQUENT_DIFFERENT, ['ENDERECOS.' . EnderecosClientes::primaryKeyName() => $endereco->primaryKey()])                    ->execute();                $action = Session::get('action');                Session::always('action', $id);                if (($to = Cookie::get('from_url')) && $action == 'update') {                    Cookie::remove('from_url');                    $this->redirectOnly($to);                } else {                    $this->redirectTo(Winged::$page_surname);                }            }else{                return ['status' => false, 'model' => $model, 'endereco' => $endereco];            }        } else {            return ['status' => false, 'model' => $model, 'endereco' => $endereco];        }    }}