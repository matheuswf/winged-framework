<?phpuse Winged\Model\Model;use Winged\Database\DbDict;use Winged\Date\Date;use Winged\Formater\Formater;use Winged\Upload\Upload;use Winged\Winged;/** * Class News */class News extends Model{    public function __construct()    {        parent::__construct();        $this->mobile = new \MobileDetect();        return $this;    }    public $mobile = null;    /**     * @var $categorias array | NewsNewsCategorias[]     */    public $categorias;    /** @var $id_new integer */    public $id_new;    /** @var $categorias array */    public $id_categoria;    /** @var $id_usuario int | Usuarios */    public $id_usuario;    /** @var $title_tag string */    public $title_tag;    /** @var $titulo string */    public $titulo;    /** @var $previa string */    public $previa;    /** @var $post string */    public $post;    /** @var $data_cadastro Date() */    public $data_cadastro;    /** @var $data_alteracao Date() */    public $data_alteracao;    /** @var $imagem string */    public $image;    /** @var $share_image string */    public $share_image;    /** @var $status integer */    public $status;    /** @var $is_video int */    public $is_video = 0;    /** @var $from_youtube string */    public $from_youtube;    /** @var $video_source int */    public $video_source;    /** @var $ordem int */    public $ordem;    /**     * @return string     */    public static function tableName()    {        return "news";    }    /**     * @param $link     *     * @return mixed|null     */    public function videoId($link)    {        $video_id = null;        if (is_int(stripos($link, 'youtu.be')) && !is_int(stripos($link, 'watch'))) {            $link = explode('youtu.be/', $link);            $link = explode('?', end($link));            $link = explode('/', array_shift($link));            $video_id = array_shift($link);        } else if (is_int(stripos($link, 'embed'))) {            $link = explode('embed/', $link);            $link = explode('?', end($link));            $link = explode('/', array_shift($link));            $video_id = array_shift($link);        } else if (is_int(stripos($link, 'watch'))) {            parse_str(parse_url($link, PHP_URL_QUERY), $vars);            $video_id = $vars['v'];        }        return $video_id;    }    /**     * @return string     */    public static function primaryKeyName()    {        return "id_new";    }    /**     * @param bool $pk     *     * @return $this|int|Model     */    public function primaryKey($pk = false)    {        if ($pk && (is_int($pk) || intval($pk) != 0)) {            $this->id_new = $pk;            return $this;        }        return $this->id_new;    }    /**     * @return array     */    public function behaviors()    {        return [            'data_cadastro' => function () {                if (Admin::isInsert() || $this->data_cadastro == null || $this->data_cadastro == '') {                    $this->data_cadastro = new Date(time());                }            },            'data_alteracao' => function () {                $this->data_alteracao = new Date(time());            },            'post' => function () {                $html = $this->post;                $return = stripslashes(nltobr(htmlentities($html, ENT_NOQUOTES)));                $_POST[__CLASS__]['post'] = $return;                return $return;            },            'previa' => function () {                return nltobr($this->previa);            },            'status' => function () {                if (Admin::isUpdate()) {                    if (!$this->loaded('status')) {                        return 0;                    }                }                return null;            },            'categorias' => function () {                if (is_array($this->categorias)) {                    if (array_key_exists('id_categoria', $this->categorias)) {                        $this->categorias = $this->categorias['id_categoria'];                        $this->onSaveSuccess(randid(6), function () {                            (new NewsNewsCategorias())->delete(['NNC' => NewsNewsCategorias::tableName()])                                ->where(ELOQUENT_EQUAL, ['NNC.' . News::primaryKeyName() => $this->primaryKey()])                                ->execute();                            foreach ($this->categorias as $categoria) {                                (new NewsNewsCategorias())->insert()                                    ->into(NewsNewsCategorias::tableName())                                    ->values([                                        NewsCategorias::primaryKeyName() => $categoria,                                        News::primaryKeyName() => $this->primaryKey()                                    ])->execute();                            }                        });                    }                } else {                    $this->categorias = [];                }            }        ];    }    /**     * @return array     */    public function reverseBehaviors()    {        return [            'post' => function () {                return str_replace(['<br>', 'http:http://'], ['', 'http://'], html_entity_decode($this->post));            },            'previa' => function () {                return brtonl($this->previa);            },            'categorias' => function () {                $categorias = (new NewsNewsCategorias())->select()                    ->from(['NNC' => NewsNewsCategorias::tableName()])                    ->innerJoin(ELOQUENT_EQUAL, ['NC' => NewsCategorias::tableName(), 'NC.' . NewsCategorias::primaryKeyName() => 'NNC.' . NewsCategorias::primaryKeyName()])                    ->where(ELOQUENT_EQUAL, ['NNC.' . News::primaryKeyName() => $this->primaryKey()])                    ->execute();                if ($categorias) {                    return $categorias;                }                return [];            }        ];    }    /**     * @return array     */    public function labels()    {        return [            'id_categoria' => 'Categoria do post: ',            'titulo' => 'Título do post: ',            'title_tag' => 'Título da página (o que aparece na aba do navegador): ',            'previa' => 'Previa: ',            'post' => 'Corpo do post: ',            'status' => 'Inativo / Ativo: ',            'is_video' => 'A capa do post é um vídeo: ',            'from_youtube' => 'O vídeo vem do Youtube: ',            'video_source' => 'Link para o vídeo do Youtube:  ',        ];    }    /**     * @return array     */    public function rules()    {        return [            'titulo' => [                'required' => true,                'db' => Slugs::exists($this->titulo)            ],            'previa' => [                'required' => true,            ],            'post' => [                'required' => true,            ],        ];    }    /**     * @return array     */    public function messages()    {        return [            'titulo' => [                'required' => 'Este campo é obrigatório',                'db' => 'Esse nome já é utilizado por outro registro dentro do banco de dados'            ],            'previa' => [                'required' => 'Este campo é obrigatório',            ],            'post' => [                'required' => 'Este campo é obrigatório',            ],        ];    }}